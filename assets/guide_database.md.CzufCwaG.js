import{_ as s,c as e,o as t,ag as i}from"./chunks/framework.D22YC4c3.js";const g=JSON.parse('{"title":"Database","description":"","frontmatter":{},"headers":[],"relativePath":"guide/database.md","filePath":"guide/database.md"}'),n={name:"guide/database.md"};function o(l,a,d,p,r,h){return t(),e("div",null,[...a[0]||(a[0]=[i(`<h1 id="database" tabindex="-1">Database <a class="header-anchor" href="#database" aria-label="Permalink to &quot;Database&quot;">​</a></h1><p>Database engine is <a href="https://www.postgresql.org" target="_blank" rel="noreferrer">PostgreSQL</a> and API Server is using mixture of two abstractions:</p><ul><li><p><a href="https://sequelize.org" target="_blank" rel="noreferrer">Sequelize</a> ORM</p></li><li><p><a href="https://kysely.dev" target="_blank" rel="noreferrer">Kysely</a> query builder</p></li></ul><p>Intake24 system has two main databases:</p><ul><li><code>foods</code> - contains all foods related data (e.g. foods, food groups, nutrients, etc.)</li><li><code>system</code> - contains all system related data (e.g. users, permissions, roles, feedback schemes, surveys, etc.)</li></ul><h2 id="snapshots" tabindex="-1">Snapshots <a class="header-anchor" href="#snapshots" aria-label="Permalink to &quot;Snapshots&quot;">​</a></h2><p>Intake24 provides database snapshots for databases:</p><ul><li><code>foods</code> - full database snapshot (structure + data)</li><li><code>system</code> - database structure-only snapshot (no data)</li></ul><p>If you use Docker to run Intake24 development environment, the database snapshots will be downloaded automatically when you run the docker compose script.</p><ul><li><a href="https://storage.googleapis.com/intake24/snapshots/foods_snapshot.pgcustom" target="_blank" rel="noreferrer">Foods database public download link</a></li><li><a href="https://storage.googleapis.com/intake24/snapshots/system_snapshot.sql" target="_blank" rel="noreferrer">System database public download link</a></li></ul><p>Once both databases are imported, system database needs to be initialized with default data and superuser account created using CLI <a href="/cli/init-db-system">init:db:system</a> command.</p><h2 id="images" tabindex="-1">Images <a class="header-anchor" href="#images" aria-label="Permalink to &quot;Images&quot;">​</a></h2><p>Intake24 provides food images archive:</p><ul><li><a href="https://storage.googleapis.com/intake24/images/intake24-images-MRC-LIVE-19112025.zip" target="_blank" rel="noreferrer">Foods images public download link</a></li></ul><p>Extract the downloaded archive to the desired location (e.g. <code>apps/api/storage/images</code>).</p><p>Food images can also be downloaded / extracted using <a href="/cli/init-food-images">init:food-images</a> command:</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cli</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> init:food-images</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://storage.googleapis.com/intake24/images/intake24-images-MRC-LIVE-19112025.zip</span></span></code></pre></div><div class="warning custom-block"><p class="custom-block-title">WARNING</p><p>Images are very large (more than 18GB). Make sure you have enough disk space before downloading and extracting the archive.</p></div><p>Refer to <a href="/config/api/filesystem#images-dir">Configuration -&gt; Filesystem</a> how to configure image assets directory.</p><h2 id="migrations" tabindex="-1">Migrations <a class="header-anchor" href="#migrations" aria-label="Permalink to &quot;Migrations&quot;">​</a></h2><p>Database migrations are being handled by <a href="https://sequelize.org/docs/v6/other-topics/migrations" target="_blank" rel="noreferrer">sequelize-cli</a>.</p><h3 id="migrate-system-database" tabindex="-1">Migrate system database <a class="header-anchor" href="#migrate-system-database" aria-label="Permalink to &quot;Migrate system database&quot;">​</a></h3><p>Migration commands can be being executed either from <code>project root</code> or <code>packages/db</code> directory.</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> db:system:migrate</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># shorthand for</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sequelize</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> db:migrate</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --options-path</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sequelize/system/options.js</span></span></code></pre></div><h3 id="migrate-foods-database" tabindex="-1">Migrate foods database <a class="header-anchor" href="#migrate-foods-database" aria-label="Permalink to &quot;Migrate foods database&quot;">​</a></h3><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> db:foods:migrate</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># shorthand for</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sequelize</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> db:migrate</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --options-path</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sequelize/foods/options.js</span></span></code></pre></div><h2 id="import-database-snapshots" tabindex="-1">Import database snapshots <a class="header-anchor" href="#import-database-snapshots" aria-label="Permalink to &quot;Import database snapshots&quot;">​</a></h2><p>If you have a DB snapshots of Intake24, you can use CLI to import to the database server.</p><h3 id="postgresql" tabindex="-1">PostgreSQL <a class="header-anchor" href="#postgresql" aria-label="Permalink to &quot;PostgreSQL&quot;">​</a></h3><p>PostgreSQL is running on the standard port <code>5432</code>.</p><p>The Intake24 databases are:</p><ul><li>System database: <code>intake24_system</code>, user <code>intake24</code>, no password.</li><li>Foods database: <code>intake24_foods</code>, user <code>intake24</code>, no password.</li></ul><h3 id="importing-foods-and-system-databases" tabindex="-1">Importing foods and system databases <a class="header-anchor" href="#importing-foods-and-system-databases" aria-label="Permalink to &quot;Importing foods and system databases&quot;">​</a></h3><div class="warning custom-block"><p class="custom-block-title">WARNING</p><p>Note: The scripts in this sessions aimed for setup PostgreSQL for Intake24 local development purpose only.</p></div><ol><li>Export PostgresQL username password and host name to local development environment.</li></ol><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>export PGUSER=&#39;postgres&#39;</span></span>
<span class="line"><span>export PGPASSWORD=&#39;postgres&#39;</span></span>
<span class="line"><span>export PGHOST=&quot;localhost&quot;</span></span></code></pre></div><ol start="2"><li>Create a user in Postgres called <code>intake24</code> with password <code>intake24</code></li></ol><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>psql -d postgres -c &quot;CREATE ROLE intake24 WITH PASSWORD &#39;intake24&#39; LOGIN;&quot;</span></span></code></pre></div><ol start="3"><li>Create DB <code>intake24_foods</code> and add extensions</li></ol><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>createdb --owner=intake24 intake24_foods</span></span>
<span class="line"><span>psql -d intake24_foods -c &quot;create extension btree_gist&quot;</span></span>
<span class="line"><span>psql -d intake24_foods -c &quot;create extension \\&quot;uuid-ossp\\&quot;&quot;</span></span></code></pre></div><ol start="4"><li>Import snapshot file to DB <code>intake24_foods</code></li></ol><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>pg_restore -n public --no-owner --no-acl --role=intake24 --dbname intake24_foods ./intake24-foods-snapshot.pgcustom</span></span></code></pre></div><p>Change the path of the snapshot file as needed, e.g. <code>intake24-foods-snapshot.pgcustom</code></p><ol start="5"><li>Create DB <code>intake24_system</code></li></ol><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>createdb --owner=intake24 intake24_system</span></span></code></pre></div><ol start="6"><li>Import snapshot file to DB <code>intake24_system</code>.</li></ol><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>pg_restore -n public --no-owner --no-acl --role=intake24 --dbname intake24_system ./intake24-system-snapshot.pgcustom</span></span></code></pre></div><p>Change the path of the snapshot file as needed, e.g. <code>intake24-system-snapshot.pgcustom</code></p><ol start="7"><li>Login to <code>intake24_system</code> using PSQL, and insert admin user (e.g. <code>admin@example.com</code>, or any email you prefer) to <code>users</code> table.</li></ol><p>Write down return user id. It will be useful in the next step.</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>psql -d intake24_system</span></span>
<span class="line"><span></span></span>
<span class="line"><span>insert into users (id, &quot;name&quot;, email, phone, simple_name, email_notifications, sms_notifications, multi_factor_authentication, created_at, updated_at, verified_at, disabled_at) values (default, &#39;Admin&#39;, &#39;admin@example.com&#39;, &#39;&#39;, &#39;Admin&#39;, true, true, false, now(), now(), now(), null) returning id;</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>id</span></span>
<span class="line"><span>-------</span></span>
<span class="line"><span>11969</span></span>
<span class="line"><span>(1 row)</span></span></code></pre></div><ol start="8"><li>Go to the <code>apps/cli</code> directory in the source tree and run</li></ol><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>pnpm run cli hash-password [your password]</span></span></code></pre></div><p>Replace <code>[your password]</code> to the password you want.</p><ol start="9"><li>Replace <code>[hash]</code> and <code>[salt]</code> with the password hash and salt generated, and insert to user by id.</li></ol><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>insert into user_passwords (user_id, password_hash, password_salt, password_hasher) values (11969, &#39;[hash]&#39;, &#39;[salt]&#39;, &#39;bcrypt&#39;);</span></span></code></pre></div><ol start="10"><li>Give this user id superuser permissions:</li></ol><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>insert into role_user (role_id, user_id, created_at, updated_at) values (1, 11969, now(), now());</span></span></code></pre></div><p>By that you created admin test account <code>admin@example.com</code> in development database.</p><h2 id="upgrade-guide" tabindex="-1">Upgrade guide <a class="header-anchor" href="#upgrade-guide" aria-label="Permalink to &quot;Upgrade guide&quot;">​</a></h2><p>Intake24 V3 to V4 upgrade guide (WIP)</p><h3 id="migrate-databases" tabindex="-1">Migrate databases <a class="header-anchor" href="#migrate-databases" aria-label="Permalink to &quot;Migrate databases&quot;">​</a></h3><p>Use most up-to-date V3 <code>foods</code> and <code>system</code> databases to run the migrations.</p><ol><li>Migrate system database</li></ol><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> db:system:migrate</span></span></code></pre></div><ol start="2"><li>Migrate foods database</li></ol><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> db:foods:migrate</span></span></code></pre></div><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>Depending on size of the databases, migration process can take from seconds to minutes. Both databases are being upgraded to use int8 instead of int4, which takes most of the time.</p><p>If you run into query timeout issues, you will have to increase the limits in sequelize config file (<code>packages/db/sequelize/{foods|system}/config.js</code>).</p></div><div class="warning custom-block"><p class="custom-block-title">WARNING</p><p>Run the migration in specified order per above.</p><p>Some of the system database migrations are using foods database data (e.g. feedback data conversion into feedback-schemes) and eventually V3 old tables are dropped. Running the migrations in wrong order will fail.</p></div><h3 id="seed-databases-with-relevant-data" tabindex="-1">Seed databases with relevant data <a class="header-anchor" href="#seed-databases-with-relevant-data" aria-label="Permalink to &quot;Seed databases with relevant data&quot;">​</a></h3><p>Some of V3 data are being moved to database. To get this data into the database, run relevant seeders.</p><h4 id="standard-units" tabindex="-1">Standard units <a class="header-anchor" href="#standard-units" aria-label="Permalink to &quot;Standard units&quot;">​</a></h4><p>Standard units are being moved from V3 translation files to database. To seed the database with V3 source code standard units, run the following command:</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> packages/db</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sequelize</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> db:seed</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --seed</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> v3-standard-units.js</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --options-path</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sequelize/foods/options.js</span></span></code></pre></div><h4 id="recipe-foods" tabindex="-1">Recipe foods <a class="header-anchor" href="#recipe-foods" aria-label="Permalink to &quot;Recipe foods&quot;">​</a></h4><p>Recipe foods are being moved from V3 translation files to database. To seed the database with V3-like data, run the following command:</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> packages/db</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sequelize</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> db:seed</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --seed</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> v3-recipe-foods.js</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --options-path</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sequelize/foods/options.js</span></span></code></pre></div><h2 id="system-database-clean-up" tabindex="-1">System database clean-up <a class="header-anchor" href="#system-database-clean-up" aria-label="Permalink to &quot;System database clean-up&quot;">​</a></h2><h3 id="truncate-all-tables-except-sequelize-meta" tabindex="-1">Truncate all tables except <code>sequelize_meta</code> <a class="header-anchor" href="#truncate-all-tables-except-sequelize-meta" aria-label="Permalink to &quot;Truncate all tables except \`sequelize_meta\`&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">TRUNCATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> TABLE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> \`table\`</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> RESTART</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> IDENTITY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> CASCADE;</span></span></code></pre></div><h3 id="re-initialize-data" tabindex="-1">Re-initialize data <a class="header-anchor" href="#re-initialize-data" aria-label="Permalink to &quot;Re-initialize data&quot;">​</a></h3><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cli</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> init:db:system</span></span></code></pre></div>`,83)])])}const u=s(n,[["render",o]]);export{g as __pageData,u as default};
